package sparkbasics

import init.InitSpark
import org.apache.spark.sql.expressions.Window

object WindowAnalyticFunctions extends InitSpark {

  import org.apache.spark.sql.functions._
  import spark.implicits._

  val data = Seq(
    (1, 99),
    (1, 99),
    (1, 70),
    (1, 20),
    (1, 66),
    (2, 55),
    (2, 99),
    (2, 87),
    (3, 1),
    (3, -23),
    (3, -66)
  ).toDF("id", "value")

  data.show()

  data.select('id, 'value, cume_dist().over(Window.orderBy('value))).show()
  data.select('id, 'value, last('value).over(Window.orderBy('id))).show()
  data.select('id, 'value, first('value).over(Window.orderBy('id))).show()
  data.select('id, 'value, lag('value, 1).over(Window.partitionBy('id).orderBy('value))).show()
  data.select('id, 'value, lead('value, 1).over(Window.partitionBy('id).orderBy('value))).show()

}

/*

+---+-----+
| id|value|
+---+-----+
|  1|   99|
|  1|   99|
|  1|   70|
|  1|   20|
|  1|   66|
|  2|   55|
|  2|   99|
|  2|   87|
|  3|    1|
|  3|  -23|
|  3|  -66|
+---+-----+

+---+-----+---------------------------------------------------------------------+
| id|value|cume_dist() OVER (ORDER BY value ASC NULLS FIRST unspecifiedframe$())|
+---+-----+---------------------------------------------------------------------+
|  3|  -66|                                                  0.09090909090909091|
|  3|  -23|                                                  0.18181818181818182|
|  3|    1|                                                   0.2727272727272727|
|  1|   20|                                                  0.36363636363636365|
|  2|   55|                                                  0.45454545454545453|
|  1|   66|                                                   0.5454545454545454|
|  1|   70|                                                   0.6363636363636364|
|  2|   87|                                                   0.7272727272727273|
|  1|   99|                                                                  1.0|
|  1|   99|                                                                  1.0|
|  2|   99|                                                                  1.0|
+---+-----+---------------------------------------------------------------------+

+---+-----+-------------------------------------------------------------------------+
| id|value|last(value, false) OVER (ORDER BY id ASC NULLS FIRST unspecifiedframe$())|
+---+-----+-------------------------------------------------------------------------+
|  1|   99|                                                                       66|
|  1|   99|                                                                       66|
|  1|   70|                                                                       66|
|  1|   20|                                                                       66|
|  1|   66|                                                                       66|
|  2|   55|                                                                       87|
|  2|   99|                                                                       87|
|  2|   87|                                                                       87|
|  3|    1|                                                                      -66|
|  3|  -23|                                                                      -66|
|  3|  -66|                                                                      -66|
+---+-----+-------------------------------------------------------------------------+

+---+-----+--------------------------------------------------------------------------+
| id|value|first(value, false) OVER (ORDER BY id ASC NULLS FIRST unspecifiedframe$())|
+---+-----+--------------------------------------------------------------------------+
|  1|   99|                                                                        99|
|  1|   99|                                                                        99|
|  1|   70|                                                                        99|
|  1|   20|                                                                        99|
|  1|   66|                                                                        99|
|  2|   55|                                                                        99|
|  2|   99|                                                                        99|
|  2|   87|                                                                        99|
|  3|    1|                                                                        99|
|  3|  -23|                                                                        99|
|  3|  -66|                                                                        99|
+---+-----+--------------------------------------------------------------------------+

+---+-----+---------------------------------------------------------------------------------------------+
| id|value|lag(value, 1, NULL) OVER (PARTITION BY id ORDER BY value ASC NULLS FIRST unspecifiedframe$())|
+---+-----+---------------------------------------------------------------------------------------------+
|  1|   20|                                                                                         null|
|  1|   66|                                                                                           20|
|  1|   70|                                                                                           66|
|  1|   99|                                                                                           70|
|  1|   99|                                                                                           99|
|  3|  -66|                                                                                         null|
|  3|  -23|                                                                                          -66|
|  3|    1|                                                                                          -23|
|  2|   55|                                                                                         null|
|  2|   87|                                                                                           55|
|  2|   99|                                                                                           87|
+---+-----+---------------------------------------------------------------------------------------------+

+---+-----+----------------------------------------------------------------------------------------------+
| id|value|lead(value, 1, NULL) OVER (PARTITION BY id ORDER BY value ASC NULLS FIRST unspecifiedframe$())|
+---+-----+----------------------------------------------------------------------------------------------+
|  1|   20|                                                                                            66|
|  1|   66|                                                                                            70|
|  1|   70|                                                                                            99|
|  1|   99|                                                                                            99|
|  1|   99|                                                                                          null|
|  3|  -66|                                                                                           -23|
|  3|  -23|                                                                                             1|
|  3|    1|                                                                                          null|
|  2|   55|                                                                                            87|
|  2|   87|                                                                                            99|
|  2|   99|                                                                                          null|
+---+-----+----------------------------------------------------------------------------------------------+
 */
